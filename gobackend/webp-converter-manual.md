# WebP 转换工具使用手册

## 目录

- [简介](#简介)
- [功能特点](#功能特点)
- [安装说明](#安装说明)
- [使用方法](#使用方法)
  - [单图处理](#单图处理)
  - [批量处理目录](#批量处理目录)
  - [JSON列表批量处理](#json列表批量处理)
- [命令行参数](#命令行参数)
- [使用示例](#使用示例)
- [图像处理技术](#图像处理技术)
- [常见问题](#常见问题)
- [性能优化建议](#性能优化建议)

## 简介

WebP 转换工具是一个高效的图片批量处理工具，可以将多种格式的图像（JPEG、PNG、GIF等）转换为 WebP 格式，同时可以选择是否保留原始文件扩展名。该工具支持单张图片处理、目录批量转换和JSON列表批量处理，具有自动检测图像类型、自动调整图像尺寸、自动矫正图像方向、保持宽高比、处理 EXIF 方向数据以及并发处理等功能。

## 功能特点

- **多格式支持**：处理 JPG、JPEG、PNG、GIF 等常见图片格式
- **图像格式自动检测**：不依赖文件扩展名，通过检测文件内容判断实际格式
- **智能尺寸调整**：自动识别图片方向（横/竖），应用最佳尺寸设置
  - 横图（宽>高）：自动调整为 1280×720px
  - 竖图（高>宽）：自动调整为 600×900px
- **EXIF 数据处理**：
  - 使用 EXIF 中的方向信息自动纠正图像方向（解决手机拍摄照片方向问题）
  - 支持8种EXIF方向标记的自动矫正
  - 移除所有元数据、配置文件和注释，减小文件大小
- **灵活的输出选项**：
  - 默认保留原文件扩展名，仅转换内容为 WebP 格式
  - 可选使用 `.webp` 扩展名
  - 可选保留或删除原始文件
- **多种批量处理模式**：
  - 支持批量处理整个目录（含递归子目录）
  - 支持处理JSON格式的图片路径列表
  - 多线程并发处理，加快转换速度
- **健壮的错误处理**：
  - 多层次解码尝试，确保最大兼容性
  - 安全的文件替换：使用临时文件 + 原子替换机制确保安全
  - 详细的日志输出，方便定位问题

## 安装说明

### 前提条件

- 安装 Go 1.16 或更高版本
- 克隆项目代码库

### 编译安装

1. 进入项目目录：
```bash
cd /path/to/gobackend
```

2. 编译应用：
```bash
go build -o webp-converter cmd/webp/main.go
```

3. 验证安装：
```bash
./webp-converter -h
```

## 使用方法

### 单图处理

基本用法：

```bash
./webp-converter -img [图片路径]
```

例如：

```bash
./webp-converter -img photo.jpg
```

这将把 `photo.jpg` 转换为 WebP 格式，但保留原始 `.jpg` 扩展名。

### 批量处理目录

基本用法：

```bash
./webp-converter -dir [目录路径]
```

例如：

```bash
./webp-converter -dir ./photos
```

这将处理 `photos` 目录下的所有图片。

### JSON列表批量处理

基本用法：

```bash
./webp-converter -json '[图片路径JSON数组]'
```

例如：

```bash
./webp-converter -json '["path/to/image1.jpg", "path/to/image2.png"]'
```

这将依次处理JSON数组中指定的所有图片路径。

## 命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `-img` | string | "" | 要转换的单个图片路径，可以是相对路径或绝对路径 |
| `-dir` | string | "" | 要批量处理的目录路径 |
| `-json` | string | "" | 图片路径的JSON列表，格式如 `["img1.jpg", "img2.png"]` |
| `-recursive` | bool | false | 是否递归处理子目录（仅在使用 `-dir` 时有效） |
| `-ratio` | bool | true | 是否保持原始宽高比 |
| `-w` | int | 0 | 最大宽度（0表示自动判断：横图1280px，竖图600px） |
| `-h` | int | 0 | 最大高度（0表示自动判断：横图720px，竖图900px） |
| `-keep` | bool | true | 是否保留原始图片（当使用 `-webp=true` 时有效） |
| `-webp` | bool | false | 是否使用 `.webp` 扩展名（默认保持原扩展名） |
| `-concurrency` | int | 4 | 并发处理的数量，仅批量处理时有效 |
| `-sync` | bool | false | 使用同步模式处理（不使用并发），批量处理时有效 |

## 使用示例

### 单图示例

1. 转换单图并使用 WebP 扩展名：
```bash
./webp-converter -img photo.jpg -webp=true
```

2. 转换单图指定尺寸并保持宽高比：
```bash
./webp-converter -img photo.jpg -w 1200 -h 800
```

3. 转换单图并删除原始文件：
```bash
./webp-converter -img photo.jpg -webp=true -keep=false
```

### 批量处理示例

1. 处理目录中的所有图片，保持原扩展名：
```bash
./webp-converter -dir ./photos
```

2. 递归处理目录及其子目录：
```bash
./webp-converter -dir ./photos -recursive=true
```

3. 批量处理并使用 WebP 扩展名：
```bash
./webp-converter -dir ./photos -webp=true
```

4. 批量处理并指定8个并行线程：
```bash
./webp-converter -dir ./photos -concurrency=8
```

5. 使用同步模式处理（避免并发）：
```bash
./webp-converter -dir ./photos -sync=true
```

### JSON列表处理示例

1. 处理JSON列表中的图片：
```bash
./webp-converter -json '["./images/photo1.jpg", "./images/photo2.png"]' -webp=true
```

2. 使用更高并发数处理大量图片：
```bash
./webp-converter -json '["img1.jpg", "img2.png", "img3.jpg"]' -concurrency=10
```

3. 处理JSON列表并删除原始文件：
```bash
./webp-converter -json '["path/to/large1.jpg", "path/to/large2.png"]' -keep=false -webp=true
```

## 图像处理技术

### 图像格式检测算法

工具采用多层检测机制确保准确识别图像格式：
1. 首先通过MIME类型检测文件内容格式
2. 如检测失败，尝试通用解码器
3. 如仍然失败，根据文件扩展名选择专用解码器
4. 最后尝试读取全部内容并使用字节流解码

### 尺寸调整算法

- **横图**（宽 > 高）：调整为最大 1280×720 像素
- **竖图**（高 > 宽）：调整为最大 600×900 像素
- 所有尺寸调整均保持原始宽高比
- 使用Lanczos重采样算法确保高质量缩放

### WebP 编码参数

- **编码质量**：80%（平衡质量和文件大小）
- **元数据**：清除所有元数据、EXIF 信息和注释

### 图像方向矫正

工具会自动从 EXIF 数据中读取方向信息（Orientation 标签），并根据以下规则纠正图像：

| Orientation 值 | 矫正方式 |
|---------------|---------|
| 1 | 不变（正常方向） |
| 2 | 水平翻转 |
| 3 | 旋转 180° |
| 4 | 垂直翻转 |
| 5 | 顺时针旋转 90° 后垂直翻转 |
| 6 | 顺时针旋转 90° |
| 7 | 顺时针旋转 90° 后水平翻转 |
| 8 | 顺时针旋转 270° |

### 文件处理流程

1. 检测图像格式和类型
2. 解码图像数据
3. 读取并应用EXIF方向信息
4. 矫正图像方向
5. 根据横竖图自动调整图像尺寸
6. 转换为 WebP 格式
7. 移除元数据
8. 安全写入文件（使用临时文件）
9. 原子替换原始文件或创建新文件

## 常见问题

### Q: 为什么默认不使用 .webp 扩展名？

**A**: 默认保留原始文件扩展名是为了确保与现有系统兼容性。许多图片管理系统和网站可能根据文件扩展名来处理图片，保留原始扩展名可以避免兼容性问题。

### Q: 工具如何处理无法识别的图片格式？

**A**: 工具使用多种策略尝试识别和处理图片：
1. 首先使用 MIME 类型检测
2. 然后尝试通用图像解码器
3. 接着尝试特定格式解码器（JPEG、PNG、GIF）
4. 最后尝试以字节流方式读取并解码
5. 若所有方法都失败，会报告错误并跳过该文件

### Q: 批量处理时，如何确保系统资源不被耗尽？

**A**: 工具使用信号量限制并发数量，默认为 4 个并发线程。您可以使用 `-concurrency` 参数根据您的系统性能调整这个值，或使用 `-sync` 参数完全禁用并发处理。

### Q: 工具如何确保文件安全？

**A**: 工具采用临时文件 + 原子替换的方式写入文件，即使在处理过程中系统崩溃，也不会导致原始文件损坏。临时文件会在处理完成后自动删除。

### Q: 如何处理手机拍摄的照片方向问题？

**A**: 工具会自动读取照片的EXIF方向标记并进行适当的旋转或翻转，确保图像显示为正确的方向，无需手动干预。

## 性能优化建议

1. **调整并发数量**: 
   - 为高性能机器增加并发数: `-concurrency=8` 或更高
   - 对于内存受限环境减少并发: `-concurrency=2`
   - 最小配置或需要稳定性时使用同步模式: `-sync=true`

2. **处理大量文件**:
   - 对大型目录，建议分批处理或增加并发数
   - 对于特别大的图片集合，推荐使用JSON列表分批处理

3. **减少磁盘IO压力**:
   - 如非必要，避免使用 `-webp=true` 创建新文件
   - 处理完成后考虑将结果移至另一存储设备

4. **内存使用优化**:
   - 处理超大图片时，建议单独处理，不要与批量任务混合
   - 设置适当的并发数，避免内存溢出 