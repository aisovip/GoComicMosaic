# 数据源接入文档

## 1. 系统概述

本系统采用了抽象层设计模式，通过数据源管理器（DataSourceManager）统一管理多个数据源，实现了搜索和播放功能与具体数据源的解耦。系统主要由以下几部分组成：

- **数据源管理器**：管理所有数据源的注册、切换和调用
- **数据源配置**：集中在一个配置文件中管理所有数据源
- **数据源工厂**：根据配置自动生成数据源实例
- **数据源接口**：定义了数据源必须实现的方法和属性

## 2. 数据源接入方式（推荐：配置驱动方式）

系统现已支持完全配置化的数据源接入方式，只需在配置文件中添加几行代码即可添加新的数据源。

### 2.1 配置文件位置

配置文件位于：`/frontend/src/utils/dataSourcesConfig.js`

### 2.2 配置参数说明

每个数据源只需配置三个核心参数：

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| name | string | 是 | 数据源显示名称 |
| baseUrl | string | 是 | API基础URL，完整的接口地址 |
| useXml | boolean | 否 | 是否使用XML格式（默认false为JSON格式） |

其他参数会自动生成：
- **id**：基于name自动生成，转为小写并移除空格和特殊字符
- **description**：基于name自动生成
- **播放源标识**：自动从baseUrl中提取（例如从`/from/lzm3u8/`中提取`lzm3u8`）

### 2.3 配置示例

```javascript
// 黑木耳数据源 (JSON格式)
{
  name: '黑木耳',
  baseUrl: 'https://json02.heimuer.xyz/api.php/provide/vod',
  useXml: false
}

// 量子数据源 (XML格式)
{
  name: '量子',
  baseUrl: 'https://cj.lziapi.com/api.php/provide/vod/from/lzm3u8/at/xml/',
  useXml: true
}
```

### 2.4 添加新数据源步骤

1. 打开 `/frontend/src/utils/dataSourcesConfig.js` 文件
2. 在`dataSourcesConfig`数组中添加新的配置对象
3. 保存文件，系统会自动加载新的数据源

## 3. 数据源接入方式（传统：文件方式）

除了推荐的配置驱动方式外，系统仍然支持传统的文件方式接入数据源。

### 3.1 复制模板文件

从 `/frontend/src/utils/dataSources/template.js.example` 复制一份模板文件，并重命名为你的数据源名称，如 `yourDataSource.js`。模板文件已支持同时处理JSON和XML格式的数据。

### 3.2 实现数据源接口

根据模板文件中的注释和示例，修改为你的数据源实现，主要需要修改以下内容：

- 基本信息（name, description）
- 配置信息（baseUrl, useXml）
- API请求参数和URL构建方式
- 响应数据解析和转换逻辑

### 3.3 自动注册机制

系统会自动扫描 `/frontend/src/utils/dataSources/` 目录下的所有 `.js` 文件（除了 `index.js` 和以 `.example` 或 `.test.js` 结尾的文件），并自动注册为数据源。

数据源ID会自动从文件名生成，例如：
- `heimuer.js` → 数据源ID为 `heimuer`
- `myCustomSource.js` → 数据源ID为 `mycustomsource`

无需手动修改任何其他文件，系统会在启动时自动加载所有数据源。

## 4. 数据格式标准

### 4.1 搜索结果格式（SearchResult）

```javascript
{
  dataList: [{ // 影片列表
    vod_id: Number|String, // 影片ID
    vod_name: String,      // 影片名称
    vod_blurb: String,     // 影片简介
    vod_pic: String,       // 影片海报URL
    vod_remarks: String,   // 影片备注（如更新至第几集）
    vod_year: String,      // 上映年份
    vod_area: String,      // 地区
    type_name: String      // 分类名称
  }],
  total: Number,           // 总条数
  pagecount: Number,       // 总页数
  size: Number,            // 每页条数
  current: Number          // 当前页码
}
```

### 4.2 影片详情格式（MovieDetail）

```javascript
{
  vod_id: Number|String,   // 影片ID
  vod_name: String,        // 影片名称
  vod_pic: String,         // 影片海报URL
  vod_blurb: String,       // 影片简介
  vod_content: String,     // 影片详细介绍
  vod_play_url: String,    // 播放地址（格式：集数$地址#集数$地址）
  vod_year: String,        // 上映年份
  vod_area: String,        // 地区
  vod_remarks: String,     // 备注信息
  type_name: String,       // 分类名称
  vod_actor: String,       // 演员
  vod_director: String     // 导演
}
```

## 5. CORS代理使用说明

由于大多数API都有跨域限制，系统提供了CORS代理功能：

```javascript
import { addCorsProxy } from './corsProxy';

// 使用方法
const url = addCorsProxy(`${this.baseUrl}${endpoint}`);
```

代理服务器会转发请求并返回响应，绕过浏览器的跨域限制。

## 6. 播放源标识说明

系统会自动从API地址中提取播放源标识：

1. 如果URL包含 `/from/xxx/` 格式，会自动提取 `xxx` 作为播放源标识
2. 如果没有，则使用数据源ID作为默认播放源标识

这个播放源标识用于在XML格式的API中，匹配播放源：

```javascript
ddElements.forEach(dd => {
  const flag = dd.getAttribute('flag');
  if (!flag || flag === playSourceFlag) {
    videoObj.vod_play_url = getCDataContent(dd);
  }
});
```

对于大多数API，系统会自动处理，无需手动配置。

## 7. JSON和XML双格式支持

系统现已支持同时处理JSON和XML格式的API数据源，只需简单配置即可切换。

### 7.1 配置示例

```javascript
// JSON格式数据源
{
  name: '黑木耳',
  baseUrl: 'https://json02.heimuer.xyz/api.php/provide/vod',
  useXml: false
}

// XML格式数据源
{
  name: '量子',
  baseUrl: 'https://cj.lziapi.com/api.php/provide/vod/from/lzm3u8/at/xml/',
  useXml: true
}
```

### 7.2 格式自动检测

系统会根据配置和响应内容自动检测并处理不同的数据格式：

```javascript
// 检查是否是XML响应 - 可能是配置为XML或者响应格式是XML
const isXmlResponse = useXml || 
  (typeof response.data === 'string' && response.data.trim().startsWith('<?xml'));

if (isXmlResponse) {
  // 解析XML
  return this.parseXMLResponse(response.data);
} else {
  // 解析JSON
  // ...
}
```

## 8. 故障排查指南

如果数据源集成后无法正常工作，请检查以下几点：

1. **配置正确性**：确认name和baseUrl是否正确
2. **XML/JSON设置**：确认useXml设置是否正确
3. **控制台错误**：查看浏览器控制台是否有错误信息
4. **网络请求**：在Network标签中查看请求是否成功
5. **CORS问题**：确认是否正确使用了CORS代理
6. **数据格式**：确认返回的数据格式是否符合系统要求
7. **API接口变化**：检查目标API是否有更新或变化
8. **XML解析**：XML格式的数据源要确保正确处理CDATA节点和特殊字符
9. **播放源问题**：如果无法获取播放地址，检查URL中的`/from/xxx/`部分是否正确

## 9. 参考资料

- 详细的添加数据源指南: `/frontend/添加数据源指南.md`
- 数据源模板文件: `/frontend/src/utils/dataSources/template.js.example`
- 数据源配置文件: `/frontend/src/utils/dataSourcesConfig.js`

# 添加数据源指南（简化版）

## 概述

本系统支持极简的数据源配置方式，只需配置三个核心参数即可添加新的数据源：
- `name`：数据源名称
- `baseUrl`：API基础URL
- `useXml`：是否使用XML格式

其他参数（如ID、描述、播放源标识等）会自动生成，无需手动配置。

## 添加新数据源

### 步骤1：打开配置文件

打开 `/frontend/src/utils/dataSourcesConfig.js` 文件。

### 步骤2：添加数据源配置

在文件末尾的数组中添加新的配置对象，例如：

```javascript
{
  name: '新数据源',   // 数据源显示名称（必填）
  baseUrl: 'https://api.example.com/api.php/provide/vod/',  // API基础URL（必填）
  useXml: false      // 是否使用XML格式（可选，默认false）
}
```

### 步骤3：保存文件

保存配置文件后，系统会自动加载新的数据源。

## 配置参数说明

### 必填参数

| 参数名 | 类型 | 描述 |
|--------|------|------|
| name | string | 数据源显示名称 |
| baseUrl | string | API基础URL，必须是完整的接口地址 |

### 可选参数

| 参数名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| useXml | boolean | false | 是否使用XML格式（false为JSON格式） |
| id | string | [自动生成] | 数据源ID，默认根据name自动生成 |
| timeout | number | 12000 | 请求超时时间（毫秒） |

## 自动生成的值

- **ID**: 根据name自动生成，转为小写并移除空格和特殊字符
- **描述**: 默认为"`{name}`影视API，提供电影、电视剧、动漫等内容"
- **播放源标识**: 系统会自动从baseUrl中提取播放源标识（例如从`/from/lzm3u8/`中提取`lzm3u8`）

## 示例

### JSON格式数据源

```javascript
{
  name: '黑木耳',
  baseUrl: 'https://json02.heimuer.xyz/api.php/provide/vod',
  useXml: false
}
```

### XML格式数据源

```javascript
{
  name: '量子',
  baseUrl: 'https://cj.lziapi.com/api.php/provide/vod/from/lzm3u8/at/xml/',
  useXml: true
}
```

## 常见问题

### 如何查看是否成功添加？

打开浏览器控制台，启动应用后会看到类似以下日志：
```
从配置文件加载 8 个数据源
通过配置加载数据源: heimuer (黑木耳)
通过配置加载数据源: liangzi (量子)
...
成功加载 8 个数据源
```

### 数据源不起作用怎么办？

1. 检查API地址是否正确
2. 检查XML/JSON格式设置是否正确
3. 查看浏览器控制台是否有错误信息
4. 确认API地址中的播放源信息是否正确（URL中的`/from/xxx/`部分）

### XML和JSON格式如何区分？

- XML格式API通常以 `/at/xml/` 结尾
- JSON格式API通常直接返回JSON数据
- 可以在浏览器中打开API地址，查看返回的内容格式 

希望本文档能帮助您顺利接入更多数据源。如有任何问题，请随时反馈。 